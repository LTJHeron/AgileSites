<?xml version="1.0" ?>
<!DOCTYPE FTCS SYSTEM "futuretense_cs.dtd">
<FTCS Version="1.1">
<!--
$Logfile: /VerticalApps/XcelerateC/install/Xcelerate/Populate/ElementCatalog/OpenMarket/Xcelerate/AssetType/Page/PreUpdate.xml $
$Revision: 23 $
$Modtime: 7/03/03 10:56a $
-->

<!--
- Confidential and Proprietary Information of Open Market, Inc.
-					All Rights Reserved.
-
- DESCRIPTION
-
-    When an asset is created, edited, or copied,
-    this element is called before the database update
-    function is invoked.
-
-    This element is passed in an argument: 'updatetype'
-    whose value can drive special processing based
-    on the type of update
-
-->


<if COND="Variables.updatetype=setformdefaults">
	<then>
	</then>
</if>

<if COND="Variables.updatetype=editfront">
<then>
</then>
</if>

	<if COND="Variables.updatetype=edit">
		<then>

<!-- Process new-style asset relations to get them into old-style form -->
			<CALLELEMENT NAME="OpenMarket/Xcelerate/Actions/AssetMgt/AssetChildrenFormNewGather"/>
			
<!-- Get the old name to see if it has changed -->

			<ASSET.GET NAME="theCurrentAsset" FIELD="name" OUTPUT="OriginalName"/>

<!-- Gather the input values into the object -->

			<ASSET.GATHER NAME="theCurrentAsset" PREFIX="Page" FIELDLIST="Variables.FieldsOnForm"/>
			
<!-- Update children realtions based on standard form values -->
			<CALLELEMENT NAME="OpenMarket/Xcelerate/Actions/AssetMgt/UpdateRelations">
				<ARGUMENT NAME="assetname" VALUE="theCurrentAsset"/>
				<ARGUMENT NAME="prefix" VALUE="Page"/>
			</CALLELEMENT>
			
			<!-- remove all unranked children, and add and rank all from the latest list -->
			<ASSET.REMOVECHILDREN NAME="theCurrentAsset" CODE="-"/>
			<IF COND="IsVariable.pagecontents=true">
			<THEN>
				<STRINGLIST NAME="addChildList" STR="Variables.pagecontents" DELIM=";"/>
				<SETCOUNTER NAME="rank" VALUE="0"/>
				<LOOP LIST="addChildList">
					<INCCOUNTER NAME="rank" VALUE="1"/>
					<INDEXOF STR="addChildList.ITEM" WHAT="," OUTSTR="index"/>
					<SUBSTRING STR="addChildList.ITEM" OUTSTR="assetType" ENDINDEX="Variables.index"/>
					<SUBSTRING STR="addChildList.ITEM" OUTSTR="temp" INDEX="Variables.index"/>
					<SUBSTRING STR="Variables.temp" OUTSTR="childId" INDEX="1"/>
					<ASSET.ADDCHILD NAME="theCurrentAsset" TYPE="Variables.assetType" CHILDID="Variables.childId" RANK="Counters.rank"/>
					<IF COND="IsError.Variables.errno=true">
					<THEN>
						<CSVAR NAME="Variables.errno"/>
						<CALLELEMENT NAME="OpenMarket/Xcelerate/Actions/Util/ShowError">
							<ARGUMENT NAME="error" VALUE="UpdateAssetRelationError"/>
							<ARGUMENT NAME="AssetType" VALUE="Variables.AssetType"/>
						</CALLELEMENT>
					</THEN>
					</IF>
				</LOOP>
			</THEN>
			</IF>
		</then>		
	</if>

	<if COND="Variables.updatetype=create">
		<then>

<!-- Process new-style asset relations to get them into old-style form -->
			<CALLELEMENT NAME="OpenMarket/Xcelerate/Actions/AssetMgt/AssetChildrenFormNewGather"/>

<!-- Gather the input values into the object -->

			<ASSET.GATHER NAME="theCurrentAsset" PREFIX="Page" FIELDLIST="Variables.FieldsOnForm"/>

<!-- Update children realtions based on standard form values -->
			<CALLELEMENT NAME="OpenMarket/Xcelerate/Actions/AssetMgt/UpdateRelations">
				<ARGUMENT NAME="assetname" VALUE="theCurrentAsset"/>
				<ARGUMENT NAME="prefix" VALUE="Page"/>
			</CALLELEMENT>

<!-- Add Page Contents -->
			<IF COND="IsVariable.pagecontents=true">
			<THEN>
				<STRINGLIST NAME="addChildList" STR="Variables.pagecontents" DELIM=";"/>
				<SETCOUNTER NAME="rank" VALUE="0"/>
				<LOOP LIST="addChildList">
					<INCCOUNTER NAME="rank" VALUE="1"/>
					<INDEXOF STR="addChildList.ITEM" WHAT="," OUTSTR="index"/>
					<SUBSTRING STR="addChildList.ITEM" OUTSTR="assetType" ENDINDEX="Variables.index"/>
					<SUBSTRING STR="addChildList.ITEM" OUTSTR="temp" INDEX="Variables.index"/>
					<SUBSTRING STR="Variables.temp" OUTSTR="childId" INDEX="1"/>
					<ASSET.ADDCHILD NAME="theCurrentAsset" TYPE="Variables.assetType" CHILDID="Variables.childId" RANK="Counters.rank"/>
					<IF COND="IsError.Variables.errno=true">
					<THEN>
						<CSVAR NAME="Variables.errno"/>
						<CALLELEMENT NAME="OpenMarket/Xcelerate/Actions/Util/ShowError">
							<ARGUMENT NAME="error" VALUE="UpdateAssetRelationError"/>
							<ARGUMENT NAME="AssetType" VALUE="Variables.AssetType"/>
						</CALLELEMENT>
					</THEN>
					</IF>
				</LOOP>
			</THEN>
			</IF>
		</then>
	</if>

<if COND="Variables.updatetype=delete">
	<then>
	</then>
</if>

<if COND="Variables.updatetype=remotepost">
	<then>
  <IF COND="Variables.Action=update">
    <THEN>
         <CALLELEMENT NAME="OpenMarket/Xcelerate/Actions/Util/MakeFieldListforRemotePost"/>
         <ASSET.GATHER NAME="theCurrentAsset" FIELDLIST="Variables.updateFieldList"/>
    </THEN>
    <ELSE>
        <ASSET.GATHER NAME="theCurrentAsset"/>
    </ELSE>
    </IF>
	</then>
</if>

<if COND="Variables.updatetype=updatefrom">
	<then>
	</then>
</if>
<!-- If the asset is updated from dah -->
<if COND="Variables.dashUpdate=dashUpdate">
<then>
	<if COND="Variables.dashUpdateType=create">
    <then>
		<!--if the operation is create-->
    </then>
    </if>
    <if COND="Variables.dashUpdateType=edit">
    <then>
		<!--if the operation is edit-->
    </then>
    </if>
    <if COND="Variables.dashUpdateType=delete">
    <then>
		<!--if the operation is delete-->
    </then>
    </if>
</then>
</if>

</FTCS>
